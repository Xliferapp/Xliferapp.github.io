<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Xlifer – Domov PRO</title>
  <meta name="description" content="Xlifer Pro: aplikacija za pare in prijatelje, zgodbe, objave, klepeti z deljenjem, aplikacije, profil, klici prek WebRTC." />
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{
      --bg:#0b0f14; --surface:#0f172a; --card:#111827e6;
      --text:#f3f4f6; --muted:#9ca3af;
      --brand:#60a5fa; --brand2:#34d399;
      --danger:#ef4444; --ok:#22c55e; --warn:#f59e0b;
      --ring:0 0 0 3px rgba(96,165,250,.35);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
      background:var(--bg);color:var(--text);overflow-x:hidden;
      -webkit-tap-highlight-color:transparent}
    header{position:sticky;top:0;background:#0b0f1499;
      backdrop-filter:blur(10px);z-index:10;padding:12px 20px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid #1f2937}
    .logo{display:flex;gap:.6rem;align-items:center;font-weight:800}
    .logo-mark{width:28px;height:28px;border-radius:8px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 6px 18px rgba(52,211,153,.35)}
    main{padding:16px; padding-bottom:92px; animation:fade .3s ease}
    @keyframes fade{from{opacity:.0;transform:translateY(6px)}
      to{opacity:1;transform:translateY(0)}}

    /* Stories & Feed */
    .stories{display:flex;gap:12px;overflow-x:auto;padding:10px 0}
    .story{flex:0 0 80px;height:120px;border-radius:14px;
      background:var(--card);border:1px solid #1f2937;
      display:flex;align-items:center;justify-content:center;
      font-weight:700;cursor:pointer;transition:.25s transform}
    .story:hover{transform:scale(1.05)}
    .story img{width:100%;height:100%;object-fit:cover;border-radius:14px}
    .feed{display:grid;gap:16px;margin-top:16px}
    .post{background:var(--card);border:1px solid #1f2937;border-radius:16px;
      overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .post .head{display:flex;gap:10px;align-items:center;padding:10px}
    .avatar{width:36px;height:36px;border-radius:999px;overflow:hidden;
      border:1px solid #1f2937;flex-shrink:0}
    .post img{width:100%;height:auto;display:block}
    .post .meta{color:#cbd5e1;font-size:.85rem}
    .post .actions{display:flex;gap:10px;padding:10px}
    .btn{appearance:none;border:0;border-radius:12px;padding:.5rem .8rem;
      font-weight:600;cursor:pointer;background:#1f2937;color:#e5e7eb;
      transition:.2s}
    .btn:hover{opacity:.9}
    .btn.primary{background:linear-gradient(180deg,var(--brand),#2563eb);color:#fff}

    /* Friends */
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
    .threads{display:grid;gap:10px}
    .thread{display:flex;align-items:center;gap:10px;padding:10px;
      background:#0f172a;border:1px solid #1f2937;border-radius:14px;transition:.2s}
    .thread:hover{background:#1e293b}
    .thread .meta{flex:1}
    .heart{width:28px;height:28px;border-radius:999px;display:grid;
      place-items:center;cursor:pointer;border:1px solid #1f2937;transition:.2s}
    .heart.active{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff}

    /* Create */
    .composer{background:var(--card);border:1px solid #1f2937;
      border-radius:16px;padding:12px;display:grid;gap:10px}
    .toggle{display:inline-flex;background:#0b1320;border:1px solid #1f2937;
      border-radius:999px;overflow:hidden}
    .toggle button{border:0;padding:.5rem .9rem;background:transparent;
      color:#cbd5e1;cursor:pointer}
    .toggle button.active{background:linear-gradient(180deg,var(--brand),#2563eb);color:#fff}
    .canvas{height:280px;background:#0f172a;border:1px dashed #334155;
      border-radius:14px;display:grid;place-items:center;position:relative;overflow:hidden}
    .canvas img{max-width:100%;max-height:100%}
    .floating-text{position:absolute;top:40%;left:40%;
      padding:.2rem .4rem;background:#0006;border-radius:8px;cursor:move}

    /* Apps */
    .tabs{display:flex;gap:8px;overflow-x:auto;padding:6px}
    .tabs button{border:0;background:#1f2937;color:#e5e7eb;padding:.5rem .8rem;
      border-radius:10px;cursor:pointer;white-space:nowrap}
    .tabs button.active{background:linear-gradient(180deg,var(--brand),#2563eb)}
    .panel{background:var(--card);border:1px solid #1f2937;
      border-radius:16px;padding:12px}

    /* Profile */
    .profile{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:740px){.row{grid-template-columns:1fr}}
    .kebab{position:relative}
    .menu{position:absolute;right:0;top:110%;background:#0f172a;
      border:1px solid #1f2937;border-radius:12px;padding:8px;
      display:none;z-index:20}
    .menu.active{display:block}

    /* Chat */
    .modal{position:fixed;inset:0;background:#0009;display:none;
      align-items:center;justify-content:center;z-index:60}
    .modal.active{display:flex}
    .chat{width:min(920px,92vw);height:min(85vh,720px);
      background:#0f172a;border:1px solid #1f2937;border-radius:16px;
      display:grid;grid-template-rows:auto 1fr auto}
    .chat header{display:flex;align-items:center;justify-content:space-between;
      padding:10px;border-bottom:1px solid #1f2937}
    .msgs{overflow-y:auto;padding:10px;display:grid;gap:8px}
    .msg{max-width:70%;padding:.6rem .8rem;border-radius:14px;background:#111827}
    .msg.me{margin-left:auto;background:linear-gradient(180deg,#1f3b7a,#1e40af)}
    .chat footer{display:flex;gap:8px;padding:10px;border-top:1px solid #1f2937}

    /* Dock */
    .dock{position:fixed;bottom:12px;left:0;right:0;display:flex;
      justify-content:center;z-index:50}
    .dock-inner{display:flex;gap:10px;background:#0b1320;
      backdrop-filter:blur(10px);border:1px solid #1f2937;border-radius:20px;padding:8px}
    .dock button{appearance:none;border:0;background:transparent;color:#cbd5e1;
      padding:.5rem .8rem;border-radius:12px;display:flex;gap:6px;align-items:center;
      cursor:pointer;font-size:14px}
    .dock button.active{background:linear-gradient(135deg,var(--brand),var(--brand2));color:white}

    .toast{position:fixed;left:12px;bottom:84px;background:#0b1320cc;
      border:1px solid #1f2937;color:#fff;padding:10px 12px;border-radius:12px;
      max-width:70vw;z-index:200;display:none}
    .toast.show{display:block}
  </style>
</head>
<body>
  <header>
    <div class="logo"><div class="logo-mark"></div><span>Xlifer</span></div>
    <div id="topTitle">Domov</div>
  </header>

  <!-- HOME -->
  <main id="view-home">
    <div class="stories" id="stories"><div class="story">+</div></div>
    <div class="feed" id="feed"></div>
  </main>
    <!-- FRIENDS -->
  <main id="view-friends" style="display:none">
    <div class="toolbar">
      <div class="grow"><input id="friendSearch" type="search" placeholder="Išči… (ime, @username)"></div>
      <button id="fltName" class="btn">A-Ž</button>
      <button id="fltTime" class="btn">Čas</button>
      <button id="fltFreq" class="btn">Pogostost</button>
      <button id="btnNewChat" class="btn primary">+ Nova grupa/pogovor</button>
      <button id="btnPartnerChat" class="btn" title="Zasebni klepet s partnerjem">❤ Partner</button>
      <button id="btnAddFriend" class="btn">+ Dodaj prijatelja</button>
    </div>
    <div class="threads" id="threads"></div>
  </main>

  <!-- CREATE -->
  <main id="view-create" style="display:none">
    <div class="composer">
      <div class="toggle">
        <button id="modePost" class="active" type="button">Objava</button>
        <button id="modeStory" type="button">Zgodba</button>
      </div>
      <div class="row">
        <input id="imageFile" type="file" accept="image/*"/>
        <label class="btn"><input id="asCouple" type="checkbox" style="accent-color:#2563eb"> Objavi kot par</label>
      </div>
      <div class="row">
        <select id="filterSelect">
          <option value="none">Brez filtra</option>
          <option value="grayscale(1)">Črno-belo</option>
          <option value="contrast(1.3) saturate(1.2)">Kontrast + barve</option>
          <option value="sepia(.5) saturate(1.3)">Retro</option>
          <option value="blur(1px) brightness(1.1)">Soft</option>
        </select>
        <input id="caption" type="text" placeholder="Opis (za objavo)…"/>
      </div>
      <div class="canvas" id="canvas">
        <img id="canvasImg" alt="predogled"/>
        <div id="floatingText" class="floating-text" contenteditable="true" hidden>Premakni me ✍️</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="publishBtn" class="btn primary">Objavi</button>
        <button id="clearBtn" class="btn">Počisti</button>
      </div>
    </div>
  </main>

  <!-- APPS -->
  <main id="view-apps" style="display:none">
    <div class="tabs">
      <button class="active" data-tab="todo">To-Do</button>
      <button data-tab="notes">Beležke</button>
      <button data-tab="calendar">Koledar</button>
      <button data-tab="album">Album</button>
    </div>
    <div id="tab-todo" class="panel"></div>
    <div id="tab-notes" class="panel" style="display:none"></div>
    <div id="tab-calendar" class="panel" style="display:none"></div>
    <div id="tab-album" class="panel" style="display:none"></div>
  </main>

  <!-- PROFILE -->
  <main id="view-profile" style="display:none">
    <div class="profile">
      <div class="row">
        <div style="display:flex;gap:10px;align-items:center" class="panel">
          <div class="avatar" style="width:72px;height:72px"><img id="meAvatar" alt="jaz"/></div>
          <div>
            <div style="font-weight:800" id="meName">—</div>
            <div class="meta" id="meEmail">—</div>
          </div>
        </div>
        <div class="panel kebab" style="text-align:right">
          <button id="kebabBtn" class="btn">⋯</button>
          <div id="kebabMenu" class="menu">
            <div class="muted" style="margin-bottom:6px">Koda za linkanje:</div>
            <code id="partnerCode">—</code>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>Uredi profil</h3>
        <div class="row">
          <input id="pName" type="text" placeholder="Ime"/>
          <input id="pWeb" type="url" placeholder="Spletna stran"/>
        </div>
        <div class="row">
          <input id="pIG" type="text" placeholder="Instagram"/>
          <input id="pFB" type="text" placeholder="Facebook"/>
        </div>
        <div class="row">
          <input id="pSC" type="text" placeholder="Snapchat"/>
          <input id="pDOB" type="date" placeholder="Rojstni datum"/>
        </div>
        <textarea id="pBio" placeholder="O meni" style="min-height:110px;margin-top:8px"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="saveProfile" class="btn primary">💾 Shrani</button>
          <button id="logout" class="btn">Odjava</button>
        </div>
      </div>

      <div class="panel">
        <h3>Par – skupna slika</h3>
        <input id="coupleAvatarFile" type="file" accept="image/*"/>
        <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
          <div class="avatar" style="width:96px;height:96px"><img id="coupleAvatar" alt="par"/></div>
          <button id="uploadCoupleAvatar" class="btn">📷 Naloži skupno</button>
          <button id="refreshCode" class="btn">🔄 Koda</button>
          <button id="copyCode" class="btn">📋 Kopiraj</button>
        </div>
        <div class="muted" style="margin-top:6px">
          V seznamih prijateljev se vidi tvoja + skupna slika (ne partnerjeva osebna).
        </div>
      </div>
    </div>
  </main>

  <!-- CHAT -->
  <div id="chatModal" class="modal">
    <div class="chat">
      <header>
        <div id="chatTitle">Klepet</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="chatShareToggle" class="heart" title="Deli ta klepet s partnerjem">❤</div>
          <button id="callBtn" class="btn">📞</button>
          <button id="videoBtn" class="btn">🎥</button>
          <button id="chatClose" class="btn">Zapri</button>
        </div>
      </header>
      <div id="chatMsgs" class="msgs"></div>
      <footer>
        <input id="chatInput" type="text" placeholder="Napiši sporočilo…"/>
        <button id="chatSend" class="btn primary">Pošlji</button>
      </footer>
    </div>
  </div>

  <!-- Dock -->
  <nav class="dock">
    <div class="dock-inner">
      <button data-view="home" class="active">🏠 Domov</button>
      <button data-view="friends">👥 Friends</button>
      <button data-view="create">➕ Ustvari</button>
      <button data-view="apps">🗂️ Aplikacije</button>
      <button data-view="profile">👤 Profil</button>
    </div>
  </nav>

  <div id="toast" class="toast"></div>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // 🔑 Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCaKT0CCg1xNJanG4-6Pox2UaH_1rSL3M0",
    authDomain: "chater2-fc480.firebaseapp.com",
    projectId: "chater2-fc480",
    storageBucket: "chater2-fc480.appspot.com",
    messagingSenderId: "623092508370",
    appId: "1:623092508370:web:08cf5d58c6edcfac096f0b"
  };

  // 🚀 Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // ==================== UI & TOAST ====================
  const views = document.querySelectorAll("main");
  const dockBtns = document.querySelectorAll(".dock button");
  const topTitle = document.getElementById("topTitle");
  const toast = document.getElementById("toast");

  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
  }

  dockBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      const view = btn.dataset.view;
      views.forEach(v => v.style.display = v.id === "view-" + view ? "block" : "none");
      dockBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      topTitle.textContent = btn.textContent.replace(/[^A-Za-zČŠŽčšž]/g, "");
    });
  });

  // ==================== AUTH ====================
  onAuthStateChanged(auth, user => {
    if (!user) {
      location.href = "/index.html";
    } else {
      loadProfile(user.uid);
      loadFeed();
      loadStories();
      loadThreads(user.uid);
    }
  });

  document.getElementById("logout").addEventListener("click", () => signOut(auth));

  // ==================== FEED & STORIES ====================
  async function loadFeed() {
    const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
    onSnapshot(q, snap => {
      const feed = document.getElementById("feed");
      feed.innerHTML = "";
      snap.forEach(docSnap => {
        const p = docSnap.data();
        const el = document.createElement("div");
        el.className = "post";
        el.innerHTML = `
          <div class="head">
            <div class="avatar"><img src="${p.authorAvatar || ''}" alt=""/></div>
            <div><strong>${p.authorName || '—'}</strong><div class="meta">${new Date(p.createdAt?.seconds * 1000).toLocaleString()}</div></div>
          </div>
          ${p.image ? `<img src="${p.image}" alt="slika"/>` : ""}
          <div style="padding:10px">${p.caption || ""}</div>
          <div class="actions">
            <button class="btn">❤️ ${p.likes?.length || 0}</button>
            <button class="btn">💬</button>
            <button class="btn">↗️</button>
          </div>
        `;
        feed.appendChild(el);
      });
    });
  }

  async function loadStories() {
    const stories = document.getElementById("stories");
    stories.innerHTML = `<div class="story">+</div>`;
    const q = query(collection(db, "stories"), orderBy("createdAt", "desc"));
    onSnapshot(q, snap => {
      snap.forEach(docSnap => {
        const s = docSnap.data();
        const el = document.createElement("div");
        el.className = "story";
        el.innerHTML = `<img src="${s.image}" alt="story"/>`;
        stories.appendChild(el);
      });
    });
  }

  // ==================== CREATE ====================
  const imageFile = document.getElementById("imageFile");
  const canvasImg = document.getElementById("canvasImg");
  const filterSelect = document.getElementById("filterSelect");

  imageFile.addEventListener("change", e => {
    const f = e.target.files[0];
    if (f) canvasImg.src = URL.createObjectURL(f);
  });
  filterSelect.addEventListener("input", () => canvasImg.style.filter = filterSelect.value);

  document.getElementById("publishBtn").addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) return;
    const file = imageFile.files[0];
    let url = "";
    if (file) {
      const r = ref(storage, "posts/" + Date.now() + "_" + file.name);
      await uploadBytes(r, file);
      url = await getDownloadURL(r);
    }
    const modeStory = document.getElementById("modeStory").classList.contains("active");
    const target = modeStory ? "stories" : "posts";
    await addDoc(collection(db, target), {
      authorName: user.displayName || user.email,
      authorAvatar: user.photoURL || "",
      caption: document.getElementById("caption").value,
      image: url,
      createdAt: serverTimestamp()
    });
    showToast(modeStory ? "Zgodba objavljena ✅" : "Objava objavljena ✅");
    document.getElementById("caption").value = "";
    canvasImg.src = "";
  });

  // ==================== FRIENDS & THREADS ====================
  async function loadThreads(uid) {
    const q = query(collection(db, "users", uid, "threads"), orderBy("lastAt", "desc"));
    onSnapshot(q, snap => {
      const threads = document.getElementById("threads");
      threads.innerHTML = "";
      snap.forEach(docSnap => {
        const t = docSnap.data();
        const el = document.createElement("div");
        el.className = "thread";
        el.innerHTML = `
          <div class="avatar"><img src="${t.avatar || ''}" alt=""/></div>
          <div class="meta"><strong>${t.name || '—'}</strong><div class="meta">${t.lastMsg || ""}</div></div>
          <div class="heart ${t.shared ? 'active' : ''}" data-id="${docSnap.id}">❤</div>
        `;
        el.addEventListener("click", () => openChat(docSnap.id, t.name));
        threads.appendChild(el);
      });
    });
  }

  // ==================== CHAT ====================
  const chatModal = document.getElementById("chatModal");
  const chatMsgs = document.getElementById("chatMsgs");

  async function openChat(threadId, name) {
    chatModal.classList.add("active");
    document.getElementById("chatTitle").textContent = name;
    chatMsgs.innerHTML = "";
    const q = query(collection(db, "threads", threadId, "msgs"), orderBy("createdAt"));
    onSnapshot(q, snap => {
      chatMsgs.innerHTML = "";
      snap.forEach(m => {
        const d = m.data();
        const el = document.createElement("div");
        el.className = "msg " + (d.uid === auth.currentUser.uid ? "me" : "");
        el.textContent = d.text;
        chatMsgs.appendChild(el);
      });
      chatMsgs.scrollTop = chatMsgs.scrollHeight;
    });
  }

  document.getElementById("chatSend").addEventListener("click", async () => {
    const txt = document.getElementById("chatInput").value;
    if (!txt) return;
    await addDoc(collection(db, "threads", "global", "msgs"), {
      uid: auth.currentUser.uid,
      text: txt,
      createdAt: serverTimestamp()
    });
    document.getElementById("chatInput").value = "";
  });
  document.getElementById("chatClose").addEventListener("click", () => chatModal.classList.remove("active"));

  // ==================== PROFILE ====================
  async function loadProfile(uid) {
    const user = auth.currentUser;
    document.getElementById("meName").textContent = user.displayName || "—";
    document.getElementById("meEmail").textContent = user.email || "—";
    if (user.photoURL) document.getElementById("meAvatar").src = user.photoURL;

    const snap = await getDoc(doc(db, "profiles", uid));
    if (snap.exists()) {
      const d = snap.data();
      document.getElementById("pName").value = d.name || "";
      document.getElementById("pWeb").value = d.web || "";
      document.getElementById("pIG").value = d.ig || "";
      document.getElementById("pFB").value = d.fb || "";
      document.getElementById("pSC").value = d.sc || "";
      document.getElementById("pDOB").value = d.dob || "";
      document.getElementById("pBio").value = d.bio || "";
      if (d.coupleAvatar) document.getElementById("coupleAvatar").src = d.coupleAvatar;
      if (d.partnerCode) document.getElementById("partnerCode").textContent = d.partnerCode;
    }
  }

  document.getElementById("saveProfile").addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) return;
    const data = {
      name: document.getElementById("pName").value,
      web: document.getElementById("pWeb").value,
      ig: document.getElementById("pIG").value,
      fb: document.getElementById("pFB").value,
      sc: document.getElementById("pSC").value,
      dob: document.getElementById("pDOB").value,
      bio: document.getElementById("pBio").value
    };
    await setDoc(doc(db, "profiles", user.uid), data, { merge: true });
    showToast("Profil shranjen ✅");
  });

  // ==================== WEBRTC (osnova) ====================
  document.getElementById("callBtn").addEventListener("click", () => {
    showToast("📞 Glasovni klic (WebRTC bo dodan)");
  });
  document.getElementById("videoBtn").addEventListener("click", () => {
    showToast("🎥 Video klic (WebRTC bo dodan)");
  });
</script>
</body>
</html>
