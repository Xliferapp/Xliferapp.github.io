<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Xlifer ‚Äì Domov</title>
  <meta name="description" content="Xlifer ‚Äì domaƒçi zaslon: zgodbe, objave, prijatelji, ustvarjanje objav/zgodb, aplikacije za pare (to‚Äëdo, bele≈æke, koledar, album) ter profil/nastavitve. Klepeti z nadzorom deljenja s partnerjem." />
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{
      --bg:#0b0f14; --surface:#0f172a; --card:#0f172acc; --text:#e5e7eb; --muted:#9ca3af; --brand:#60a5fa; --accent:#34d399; --danger:#ef4444; --warn:#f59e0b;
      --ring:0 0 0 3px rgba(96,165,250,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:radial-gradient(1200px 800px at 80% -10%, #1f2937 0%, transparent 60%), var(--bg); color:var(--text)}
    .container{max-width:960px; margin:0 auto; padding:16px}
    header{position:sticky; top:0; z-index:30; backdrop-filter:saturate(160%) blur(10px); background:#0b0f1499; border-bottom:1px solid #1f2937}
    header .inner{display:flex; align-items:center; justify-content:space-between; height:60px; padding:0 14px}
    .logo{display:flex; gap:.6rem; align-items:center; font-weight:800}
    .logo-mark{width:26px;height:26px;border-radius:8px;background:linear-gradient(135deg,var(--brand),var(--accent)); box-shadow:0 6px 18px rgba(52,211,153,.35)}

    /* Stories */
    .stories{display:flex; gap:12px; overflow-x:auto; padding:10px 6px}
    .story{flex:0 0 90px; height:150px; border-radius:16px; background:#111827; border:1px solid #1f2937; position:relative; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .story img{width:100%; height:100%; object-fit:cover; filter:saturate(1.05)}
    .story .name{position:absolute; left:8px; bottom:6px; font-size:.8rem; background:#0b0f14aa; padding:2px 6px; border-radius:8px}

    /* Feed */
    .feed{display:grid; gap:14px}
    .post{background:var(--card); border:1px solid #1f2937; border-radius:16px; overflow:hidden}
    .post header{position:relative; top:auto; background:transparent; border:0}
    .post .head{display:flex; align-items:center; gap:10px; padding:10px 12px}
    .avatar{width:36px;height:36px;border-radius:999px;background:#0f172a;border:1px solid #1f2937;overflow:hidden}
    .avatar img{width:100%; height:100%; object-fit:cover}
    .post .media{max-height:520px; background:#000}
    .post .media img{display:block; width:100%; height:auto}
    .post .actions{display:flex; gap:10px; padding:10px 12px}
    .btn{appearance:none; border:0; border-radius:12px; padding:.56rem .8rem; font-weight:700; cursor:pointer; background:#1f2937; color:#e5e7eb}
    .btn.primary{background:linear-gradient(180deg,var(--brand),#2563eb); color:#fff}
    .btn.ghost{background:transparent; border:1px dashed #334155}
    .btn.warn{background:linear-gradient(180deg,var(--warn),#b45309)}

    /* Friends */
    .toolbar{display:flex; gap:8px; padding:8px; background:#0b1320; border:1px solid #1f2937; border-radius:14px; align-items:center; flex-wrap:wrap}
    .toolbar .search{flex:1}
    input[type="text"], input[type="search"], input[type="url"], input[type="date"], textarea{width:100%; padding:.7rem .9rem; border-radius:12px; border:1px solid #1f2937; background:#0f172a; color:var(--text)}
    input:focus, textarea:focus{outline:none; box-shadow:var(--ring); border-color:#3b82f6}
    .list{display:grid; gap:10px; padding-top:10px}
    .thread{display:flex; align-items:center; gap:10px; padding:10px; background:#0f172a; border:1px solid #1f2937; border-radius:14px}
    .thread .meta{flex:1}
    .thread .name{font-weight:700}
    .heart{width:28px;height:28px;border-radius:999px; display:grid; place-items:center; cursor:pointer; border:1px solid #1f2937}
    .heart.active{background:linear-gradient(135deg,var(--brand),var(--accent));}

    /* Composer */
    .composer{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:12px; display:grid; gap:10px}
    .toggle{display:inline-flex; background:#0b1320; border:1px solid #1f2937; border-radius:999px; overflow:hidden}
    .toggle button{border:0; padding:.5rem .9rem; background:transparent; color:#cbd5e1; cursor:pointer}
    .toggle button.active{background:linear-gradient(180deg,var(--brand),#2563eb); color:#fff}
    .canvas{height:320px; background:#0f172a; border:1px dashed #334155; border-radius:14px; display:grid; place-items:center; position:relative; overflow:hidden}
    .canvas img{max-width:100%; max-height:100%}
    .floating-text{position:absolute; top:40%; left:40%; padding:.2rem .4rem; background:#0006; border-radius:8px; cursor:move}

    /* Apps */
    .tabs{display:flex; gap:8px; padding:6px}
    .tabs button{border:0; background:#1f2937; color:#e5e7eb; padding:.5rem .8rem; border-radius:10px; cursor:pointer}
    .tabs button.active{background:linear-gradient(180deg,var(--brand),#2563eb)}
    .app-panel{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:12px}
    .todo-item{display:flex; align-items:center; gap:8px; padding:8px; border-bottom:1px dashed #334155}

    /* Profile */
    .profile{display:grid; gap:12px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:740px){ .row{grid-template-columns:1fr} }
    .kebab{position:relative}
    .menu{position:absolute; right:0; top:110%; background:#0f172a; border:1px solid #1f2937; border-radius:12px; padding:8px; display:none}
    .menu.active{display:block}

    /* Chat modal */
    .modal{position:fixed; inset:0; background:#0009; display:none; align-items:center; justify-content:center; z-index:50}
    .modal.active{display:flex}
    .chat{width:min(860px,92vw); height:min(82vh,720px); background:#0f172a; border:1px solid #1f2937; border-radius:16px; display:grid; grid-template-rows:auto 1fr auto}
    .chat header{display:flex; align-items:center; justify-content:space-between; padding:10px; border-bottom:1px solid #1f2937}
    .msgs{overflow-y:auto; padding:10px; display:grid; gap:8px}
    .msg{max-width:70%; padding:.6rem .8rem; border-radius:14px; background:#111827}
    .msg.me{margin-left:auto; background:linear-gradient(180deg,#1f3b7a,#1e40af)}
    .chat footer{display:flex; gap:8px; padding:10px; border-top:1px solid #1f2937}

    /* Dock */
    .dock{position:fixed; bottom:12px; left:0; right:0; display:flex; justify-content:center; z-index:40}
    .dock-inner{display:flex; gap:10px; background:#0b1320; border:1px solid #1f2937; border-radius:20px; padding:8px}
    .dock button{appearance:none; border:0; background:transparent; color:#cbd5e1; padding:.5rem .8rem; border-radius:12px; display:flex; gap:8px; align-items:center; cursor:pointer}
    .dock button.active{background:linear-gradient(135deg,var(--brand),var(--accent)); color:white}

    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <div class="logo"><div class="logo-mark"></div><span>Xlifer</span></div>
      <div id="userBadge" class="muted">Nalagam‚Ä¶</div>
    </div>
  </header>

  <main class="container">
    <!-- HOME: stories + feed -->
    <section id="view-home">
      <h3>Zgodbe prijateljev</h3>
      <div class="stories" id="stories"></div>

      <div class="feed" id="feed"></div>
    </section>

    <!-- FRIENDS: toolbar + conversations list -->
    <section id="view-friends" class="hidden">
      <div class="toolbar">
        <div class="search"><input id="friendSearch" type="search" placeholder="I≈°ƒçi‚Ä¶ (ime, @username)" /></div>
        <button id="fltName" class="btn">Ime</button>
        <button id="fltTime" class="btn">ƒåas</button>
        <button id="fltFreq" class="btn">Pogostost</button>
        <button id="btnPartnerChat" class="btn warn" title="Zasebni klepet s partnerjem">‚ù§ Partner</button>
        <button id="btnNewChat" class="btn primary">+ Nova grupa/pogovor</button>
        <button id="btnAddFriend" class="btn">+ Dodaj prijatelja</button>
      </div>

      <div class="list" id="threads"></div>
    </section>

    <!-- CREATE: posts/stories composer -->
    <section id="view-create" class="hidden">
      <div class="composer">
        <div class="toggle">
          <button id="modePost" class="active" type="button">Objava</button>
          <button id="modeStory" type="button">Zgodba</button>
        </div>
        <div class="row">
          <input id="imageFile" type="file" accept="image/*" />
          <button id="btnCamera" class="btn">üì∑ Posnemi</button>
          <label style="display:flex; align-items:center; gap:8px"><input id="asCouple" type="checkbox"/> Objavi kot par</label>
        </div>
        <div class="row">
          <select id="filterSelect">
            <option value="none">Brez filtra</option>
            <option value="grayscale(1)">ƒårno-belo</option>
            <option value="contrast(1.3) saturate(1.2)">Kontrast + barve</option>
            <option value="sepia(.5) saturate(1.3)">Retro</option>
            <option value="blur(1px) brightness(1.1)">Soft</option>
          </select>
          <input id="caption" type="text" placeholder="Napi≈°i opis (za objavo)‚Ä¶" />
        </div>
        <div class="canvas" id="canvas">
          <img id="canvasImg" alt="predogled" />
          <div id="floatingText" class="floating-text hidden" contenteditable="true">Premakni me ‚úçÔ∏è</div>
        </div>
        <div class="actions" style="display:flex; gap:8px">
          <button id="publishBtn" class="btn primary">Objavi</button>
          <button id="clearBtn" class="btn ghost">Poƒçisti</button>
        </div>
      </div>
    </section>

    <!-- APPS: shared with partner -->
    <section id="view-apps" class="hidden">
      <div class="tabs">
        <button class="active" data-tab="todo">To‚ÄëDo</button>
        <button data-tab="notes">Bele≈æke</button>
        <button data-tab="calendar">Koledar</button>
        <button data-tab="album">Album</button>
      </div>
      <div class="app-panel" id="tab-todo">
        <div style="display:flex; gap:8px; align-items:center">
          <input id="todoInput" type="text" placeholder="Dodaj nalogo‚Ä¶"/>
          <button id="todoAdd" class="btn">Dodaj</button>
        </div>
        <div id="todoList"></div>
      </div>
      <div class="app-panel hidden" id="tab-notes">
        <textarea id="notesText" placeholder="Skupne bele≈æke‚Ä¶"></textarea>
        <div class="actions" style="margin-top:8px"><button id="notesSave" class="btn">Shrani</button></div>
      </div>
      <div class="app-panel hidden" id="tab-calendar">
        <div class="row">
          <input id="eventTitle" type="text" placeholder="Naslov dogodka"/>
          <input id="eventDate" type="date"/>
        </div>
        <div class="actions"><button id="eventAdd" class="btn">Dodaj dogodek</button></div>
        <div id="eventList" class="list" style="margin-top:8px"></div>
      </div>
      <div class="app-panel hidden" id="tab-album">
        <input id="albumFile" type="file" accept="image/*"/>
        <div id="albumGrid" class="stories" style="gap:10px; flex-wrap:wrap"></div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="view-profile" class="hidden">
      <div class="profile card" style="padding:12px">
        <div class="row">
          <div>
            <div style="display:flex; align-items:center; gap:10px">
              <div class="avatar" style="width:64px;height:64px"><img id="meAvatar" alt="jaz"/></div>
              <div>
                <div style="font-weight:800" id="meName">‚Äî</div>
                <div class="muted" id="meEmail">‚Äî</div>
              </div>
            </div>
          </div>
          <div class="kebab" style="text-align:right">
            <button id="kebabBtn" class="btn">‚ãØ</button>
            <div id="kebabMenu" class="menu">
              <div class="muted" style="margin-bottom:6px">Koda za linkanje partnerja:</div>
              <code id="partnerCode">‚Äî</code>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Skupna profilna slika (par)</label>
            <input id="coupleAvatarFile" type="file" accept="image/*"/>
            <div class="avatar" style="width:96px;height:96px;margin-top:6px"><img id="coupleAvatar" alt="par"/></div>
            <div class="actions" style="margin-top:8px"><button id="uploadCoupleAvatar" class="btn">Nalo≈æi skupno sliko</button></div>
          </div>
          <div>
            <label>Nastavitve</label>
            <div style="display:grid; gap:8px; margin-top:6px">
              <button id="notifTest" class="btn">Po≈°lji testno obvestilo</button>
              <button id="logout" class="btn ghost">Odjava</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px" class="muted">Prikaz v seznamih prijateljev: tvoja slika + skupna slika para (ne prika≈æe partnerjeve osebne slike).</div>
      </div>
    </section>
  </main>

  <!-- Chat modal -->
  <div id="chatModal" class="modal">
    <div class="chat">
      <header>
        <div id="chatTitle">Klepet</div>
        <div style="display:flex; gap:8px; align-items:center">
          <div id="chatShareToggle" class="heart" title="Deli ta klepet s partnerjem">‚ù§</div>
          <button id="chatClose" class="btn">Zapri</button>
        </div>
      </header>
      <div id="chatMsgs" class="msgs"></div>
      <footer>
        <input id="chatInput" type="text" placeholder="Napi≈°i sporoƒçilo‚Ä¶" />
        <button id="chatSend" class="btn primary">Po≈°lji</button>
      </footer>
    </div>
  </div>

  <!-- Dock navigation -->
  <nav class="dock">
    <div class="dock-inner">
      <button data-view="home" class="active">üè† Domov</button>
      <button data-view="friends">üë• Friends</button>
      <button data-view="create">‚ûï Ustvari</button>
      <button data-view="apps">üóÇÔ∏è Aplikacije</button>
      <button data-view="profile">üë§ Profil</button>
    </div>
  </nav>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, orderBy, onSnapshot, serverTimestamp, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    // ‚öôÔ∏è Firebase config ‚Äì uporabi svojega
    const firebaseConfig = {
      apiKey: 'AIzaSyCaKT0CCg1xNJanG4-6Pox2UaH_1rSL3M0',
      authDomain: 'chater2-fc480.firebaseapp.com',
      databaseURL: 'https://chater2-fc480-default-rtdb.firebaseio.com',
      projectId: 'chater2-fc480',
      storageBucket: 'chater2-fc480.firebasestorage.app',
      messagingSenderId: '623092508370',
      appId: '1:623092508370:web:08cf5d58c6edcfac096f0b',
      measurementId: 'G-5W40WP5YEG'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ====== Helpers ======
    const $ = (id)=>document.getElementById(id);
    const qs = (sel,root=document)=>root.querySelector(sel);
    const qsa = (sel,root=document)=>[...root.querySelectorAll(sel)];
    const userBadge = $('userBadge');

    const state = {
      me:null, coupleId:null, partnerUid:null,
      currentView:'home',
      currentThread:null
    };

    function switchView(view){
      state.currentView = view;
      ['home','friends','create','apps','profile'].forEach(v=>{
        qs('#view-'+v).classList.toggle('hidden', v!==view);
        qsa('.dock button').forEach(b=> b.classList.toggle('active', b.dataset.view===view));
      });
    }

    // Dock listeners
    qsa('.dock button').forEach(btn=> btn.addEventListener('click', ()=> switchView(btn.dataset.view)));

    // ====== Auth gate ======
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href = '/'; return; }
      state.me = user;
      userBadge.textContent = user.displayName || user.email || 'Prijavljen';
      const pSnap = await getDoc(doc(db,'profiles', user.uid));
      const p = pSnap.exists()? pSnap.data(): {};
      if(p.photoURL) $('meAvatar').src = p.photoURL;
      $('meName').textContent = user.displayName || '‚Äî';
      $('meEmail').textContent = user.email || '';

      // Couple info
      state.coupleId = p.coupleId || null;
      if(state.coupleId){
        const c = await getDoc(doc(db,'couples', state.coupleId));
        const members = c.exists()? c.data().members || [] : [];
        state.partnerUid = members.find(u=>u!==user.uid) || null;
        // Load couple avatar
        const cs = await getDoc(doc(db,'coupleSettings', state.coupleId));
        if(cs.exists() && cs.data().avatar){ $('coupleAvatar').src = cs.data().avatar; }
        // Load partner link code
        const codeSnap = await getDoc(doc(db,'coupleCodes', (cs.data()?.code)||''));
        $('partnerCode').textContent = (cs.data()?.code) || '‚Äî';
      } else {
        $('partnerCode').textContent = 'Ustvari kodo v nastavitvah';
      }

      loadStories();
      loadFeed();
      loadThreads();
      loadApps();
    });

    // ====== HOME: stories + feed (MVP) ======
    async function loadStories(){
      const el = $('stories'); el.innerHTML = '';
      // Demo: preberi zadnjih 12 storyjev
      const qy = query(collection(db,'stories'), orderBy('createdAt','desc'));
      onSnapshot(qy, (snap)=>{
        el.innerHTML = '';
        snap.docs.slice(0,12).forEach(d=>{
          const s = d.data();
          const div = document.createElement('div');
          div.className='story';
          div.innerHTML = `<img src="${s.media||''}" alt=""><div class="name">${s.authorName||'uporabnik'}</div>`;
          div.addEventListener('click', ()=> alert('Predvajanje zgodbe (MVP).'));
          el.appendChild(div);
        });
      });
    }

    async function loadFeed(){
      const feed = $('feed'); feed.innerHTML = '';
      const qy = query(collection(db,'posts'), orderBy('createdAt','desc'));
      onSnapshot(qy, (snap)=>{
        feed.innerHTML = '';
        snap.forEach(docu=>{
          const p = docu.data();
          const card = document.createElement('article');
          card.className='post';
          card.innerHTML = `
            <div class="head">
              <div class="avatar">${p.authorPhoto?`<img src="${p.authorPhoto}">`:''}</div>
              <div><div style="font-weight:800">${p.authorName||'uporabnik'}</div><div class="muted">${p.asCouple?'Objava para':'Osebna objava'}</div></div>
            </div>
            <div class="media">${p.media?`<img src="${p.media}">`:''}</div>
            <div style="padding:8px 12px">${p.caption||''}</div>
            <div class="actions">
              <button class="btn" data-like="${docu.id}">‚ù§ V≈°eƒç mi je (${p.likes||0})</button>
              <button class="btn" data-cmt="${docu.id}">üí¨ Komentiraj</button>
              <button class="btn" data-share="${docu.id}">‚Üó Posreduj</button>
            </div>`;
          card.addEventListener('click', (e)=>{
            const id = e.target.getAttribute('data-like')||e.target.getAttribute('data-cmt')||e.target.getAttribute('data-share');
            if(!id) return;
            if(e.target.hasAttribute('data-like')) updateDoc(doc(db,'posts',id), { likes: (p.likes||0)+1 });
            if(e.target.hasAttribute('data-cmt')) openThreadForPost(id);
            if(e.target.hasAttribute('data-share')) alert('Deljenje ‚Äì MVP');
          });
          feed.appendChild(card);
        });
      });
    }

    // ====== FRIENDS: conversations ======
    async function loadThreads(){
      const list = $('threads'); list.innerHTML = '';
      const qy = query(collection(db,'threads'), where('members','array-contains', state.me.uid), orderBy('updatedAt','desc'));
      onSnapshot(qy, (snap)=>{
        list.innerHTML='';
        snap.forEach(d=>{
          const t=d.data();
          const div=document.createElement('div');
          div.className='thread';
          const shared = !!t.shareWithPartner;
          div.innerHTML=`<div class="avatar"></div><div class="meta"><div class="name">${t.title||'Pogovor'}</div><div class="muted">${(t.lastMsg||'').slice(0,64)}</div></div><div class="heart ${shared?'active':''}" title="Deli s partnerjem">‚ù§</div><button class="btn">Odpri</button>`;
          const heart = qs('.heart',div);
          heart.addEventListener('click', async ()=>{
            await updateDoc(doc(db,'threads', d.id), { shareWithPartner: !shared });
          });
          qs('.btn',div).addEventListener('click', ()=> openChat(d.id,t));
          list.appendChild(div);
        });
      });
    }

    $('btnPartnerChat').addEventListener('click', async ()=>{
      // ustvari ali odpri privat thread med menoj in partnerjem
      if(!state.partnerUid){ alert('Par ≈°e ni povezan.'); return; }
      // poi≈°ƒçi thread kjer sta toƒçno ta 2 ƒçlana in type==partner
      const qy = query(collection(db,'threads'), where('type','==','partner'), where('members','array-contains', state.me.uid));
      const snap = await onGet(qy);
      let id=null, tData=null;
      snap.forEach(d=>{ const t=d.data(); if(t.members?.includes(state.partnerUid)) { id=d.id; tData=t; }});
      if(!id){
        const ref = await addDoc(collection(db,'threads'), { type:'partner', members:[state.me.uid, state.partnerUid], title:'Partner', shareWithPartner:true, createdAt:serverTimestamp(), updatedAt:serverTimestamp() });
        id = ref.id; tData={ title:'Partner', shareWithPartner:true };
      }
      openChat(id,tData);
    });

    // Utility to get snapshot once
    function onGet(qy){
      return new Promise(res=>{
        const unsub = onSnapshot(qy, (snap)=>{ unsub(); res(snap); });
      });
    }

    $('btnNewChat').addEventListener('click', ()=> alert('Izbira prijateljev za novo grupo ‚Äì MVP'));
    $('btnAddFriend').addEventListener('click', async ()=>{
      const uname = prompt('Vpi≈°i @username prijatelja:'); if(!uname) return;
      const uDoc = await getDoc(doc(db,'usernames', uname.replace(/^@/, '').toLowerCase()));
      if(!uDoc.exists()) return alert('Uporabnik ne obstaja');
      const targetEmail = uDoc.data().email; // za kasnej≈°e povabilo
      alert('Najdeno: '+targetEmail+' (MVP dodajanje)');
    });

    // ====== Chat modal ======
    const chatModal = $('chatModal');
    const chatMsgs = $('chatMsgs');
    const chatTitle = $('chatTitle');
    const chatShareToggle = $('chatShareToggle');
    const chatInput = $('chatInput');

    let unsubMessages = null; // for live updates

    function openChat(threadId, tData){
      state.currentThread = threadId;
      chatTitle.textContent = tData?.title || 'Klepet';
      chatModal.classList.add('active');
      // load messages
      unsubMessages && unsubMessages();
      const qy = query(collection(db,'threads', threadId, 'messages'), orderBy('createdAt','asc'));
      unsubMessages = onSnapshot(qy, (snap)=>{
        chatMsgs.innerHTML='';
        snap.forEach(m=>{
          const msg=m.data();
          const div=document.createElement('div');
          div.className='msg'+(msg.author===state.me.uid?' me':'');
          div.textContent = msg.text||'';
          chatMsgs.appendChild(div);
        });
        chatMsgs.scrollTop = chatMsgs.scrollHeight;
      });
      // load share flag
      onSnapshot(doc(db,'threads',threadId), (snap)=>{
        const shared = snap.data()?.shareWithPartner || false;
        chatShareToggle.classList.toggle('active', shared);
        chatShareToggle.title = shared? 'Partner ima dostop (klik za izklop)': 'Daj partnerju dostop (klik)';
      });
    }

    $('chatSend').addEventListener('click', async ()=>{
      if(!state.currentThread) return;
      const text = $('chatInput').value.trim(); if(!text) return;
      await addDoc(collection(db,'threads', state.currentThread, 'messages'), { text, author: state.me.uid, createdAt: serverTimestamp() });
      await updateDoc(doc(db,'threads', state.currentThread), { lastMsg: text, updatedAt: serverTimestamp() });
      $('chatInput').value='';
    });
    $('chatClose').addEventListener('click', ()=>{ chatModal.classList.remove('active'); unsubMessages && unsubMessages(); });

    // Toggle share with partner (friends view heart & chat header heart)
    chatShareToggle.addEventListener('click', async ()=>{
      if(!state.currentThread) return;
      const tRef = doc(db,'threads', state.currentThread);
      const snap = await getDoc(tRef);
      const shared = !!snap.data()?.shareWithPartner;
      await updateDoc(tRef, { shareWithPartner: !shared });
    });

    // ====== CREATE: composer ======
    const modePost = $('modePost');
    const modeStory = $('modeStory');
    const canvasImg = $('canvasImg');
    const filterSelect = $('filterSelect');
    const floatingText = $('floatingText');

    function setCreateMode(story){
      modePost.classList.toggle('active', !story);
      modeStory.classList.toggle('active', !!story);
      floatingText.classList.toggle('hidden', !story);
      $('caption').placeholder = story? 'Zgodba: napis premakni na sliko‚Ä¶' : 'Napi≈°i opis (za objavo)‚Ä¶';
    }
    modePost.addEventListener('click', ()=> setCreateMode(false));
    modeStory.addEventListener('click', ()=> setCreateMode(true));
    setCreateMode(false);

    $('imageFile').addEventListener('change', ()=>{
      const f = $('imageFile').files?.[0]; if(!f) return; canvasImg.src = URL.createObjectURL(f);
    });
    filterSelect.addEventListener('change', ()=> canvasImg.style.filter = filterSelect.value);

    // Draggable floating text
    let dragging=false, offX=0, offY=0;
    floatingText.addEventListener('mousedown', (e)=>{ dragging=true; offX=e.offsetX; offY=e.offsetY; });
    document.addEventListener('mouseup', ()=> dragging=false);
    document.addEventListener('mousemove', (e)=>{
      if(!dragging) return; const c= $('canvas').getBoundingClientRect();
      floatingText.style.left = Math.min(Math.max(e.clientX - c.left - offX, 0), c.width-80)+ 'px';
      floatingText.style.top = Math.min(Math.max(e.clientY - c.top - offY, 0), c.height-30)+ 'px';
    });

    $('publishBtn').addEventListener('click', async ()=>{
      const asStory = modeStory.classList.contains('active');
      const f = $('imageFile').files?.[0];
      let mediaURL = '';
      if(f){
        const r = ref(storage, `${asStory?'stories':'posts'}/${state.me.uid}/${Date.now()}_${f.name}`);
        await uploadBytes(r, f); mediaURL = await getDownloadURL(r);
      }
      const data = {
        author: state.me.uid,
        authorName: state.me.displayName||'uporabnik',
        authorPhoto: $('meAvatar').src||null,
        media: mediaURL,
        asCouple: $('asCouple').checked && !!state.coupleId,
        caption: $('caption').value.trim(),
        createdAt: serverTimestamp(),
        likes:0
      };
      if(asStory){ await addDoc(collection(db,'stories'), data); }
      else { await addDoc(collection(db,'posts'), data); }
      alert('Objavljeno!');
      $('imageFile').value=''; $('caption').value=''; canvasImg.removeAttribute('src');
    });
    $('clearBtn').addEventListener('click', ()=>{ $('imageFile').value=''; $('caption').value=''; canvasImg.removeAttribute('src'); });

    // ====== APPS ======
    qsa('.tabs button').forEach(b=> b.addEventListener('click', ()=>{
      qsa('.tabs button').forEach(x=>x.classList.remove('active')); b.classList.add('active');
      ['todo','notes','calendar','album'].forEach(t=> qs('#tab-'+t).classList.toggle('hidden', t!==b.dataset.tab));
    }));

    function collPath(name){
      // ƒåe obstaja coupleId in gre za skupne aplikacije, hranimo pod couples/{id}/apps/{name}
      return state.coupleId? { col: collection(db,'couples', state.coupleId, 'apps', name, 'items') } : { col: collection(db,'users', state.me.uid, 'apps', name, 'items') };
    }

    // To‚ÄëDo
    $('todoAdd').addEventListener('click', async ()=>{
      const txt = $('todoInput').value.trim(); if(!txt) return;
      const { col } = collPath('todo');
      await addDoc(col, { text:txt, done:false, createdAt:serverTimestamp(), by: state.me.uid });
      $('todoInput').value='';
    });
    function loadTodo(){
      const { col } = collPath('todo');
      onSnapshot(query(col, orderBy('createdAt','asc')), (snap)=>{
        const list=$('todoList'); list.innerHTML='';
        snap.forEach(d=>{
          const it=d.data(); const row=document.createElement('div'); row.className='todo-item';
          row.innerHTML = `<input type="checkbox" ${it.done?'checked':''}/> <div style="flex:1">${it.text}</div>`;
          qs('input',row).addEventListener('change', ()=> updateDoc(d.ref, { done: !it.done }));
          list.appendChild(row);
        });
      });
    }

    // Notes
    $('notesSave').addEventListener('click', async ()=>{
      const text=$('notesText').value;
      const ref = state.coupleId? doc(db,'couples',state.coupleId,'apps','notes') : doc(db,'users',state.me.uid,'apps','notes');
      await setDoc(ref, { text, updatedAt:serverTimestamp() }, { merge:true });
      alert('Bele≈æke shranjene');
    });
    async function loadNotes(){
      const ref = state.coupleId? doc(db,'couples',state.coupleId,'apps','notes') : doc(db,'users',state.me.uid,'apps','notes');
      const s = await getDoc(ref); if(s.exists()) $('notesText').value = s.data().text||'';
    }

    // Calendar
    $('eventAdd').addEventListener('click', async ()=>{
      const title=$('eventTitle').value.trim(); const date=$('eventDate').value; if(!title||!date) return;
      const { col } = collPath('calendar');
      await addDoc(col, { title, date, createdAt:serverTimestamp(), by: state.me.uid });
      $('eventTitle').value=''; $('eventDate').value='';
    });
    function loadCalendar(){
      const { col } = collPath('calendar');
      onSnapshot(query(col, orderBy('date','asc')), (snap)=>{
        const el=$('eventList'); el.innerHTML='';
        snap.forEach(d=>{
          const it=d.data(); const row=document.createElement('div'); row.className='thread';
          row.innerHTML = `<div class="meta"><div class="name">${it.title}</div><div class="muted">${it.date}</div></div>`;
          el.appendChild(row);
        });
      });
    }

    // Album
    $('albumFile').addEventListener('change', async ()=>{
      const f = $('albumFile').files?.[0]; if(!f) return;
      const r = ref(storage, `albums/${state.coupleId||state.me.uid}/${Date.now()}_${f.name}`);
      await uploadBytes(r, f); const url = await getDownloadURL(r);
      const { col } = collPath('album');
      await addDoc(col, { url, by: state.me.uid, createdAt:serverTimestamp() });
    });
    function loadAlbum(){
      const { col } = collPath('album');
      onSnapshot(query(col, orderBy('createdAt','desc')), (snap)=>{
        const grid = $('albumGrid'); grid.innerHTML='';
        snap.forEach(d=>{ const it=d.data(); const img=new Image(); img.src=it.url; img.className='story'; grid.appendChild(img); });
      });
    }

    function loadApps(){ loadTodo(); loadNotes(); loadCalendar(); loadAlbum(); }

    // ====== Profile actions ======
    $('kebabBtn').addEventListener('click', ()=> $('kebabMenu').classList.toggle('active'));
    $('uploadCoupleAvatar').addEventListener('click', async ()=>{
      if(!state.coupleId) return alert('Par ≈°e ni povezan.');
      const f = $('coupleAvatarFile').files?.[0]; if(!f) return alert('Izberi sliko.');
      const r = ref(storage, `couples/${state.coupleId}/avatar_${Date.now()}_${f.name}`);
      await uploadBytes(r, f); const url = await getDownloadURL(r);
      await setDoc(doc(db,'coupleSettings', state.coupleId), { avatar:url }, { merge:true });
      $('coupleAvatar').src = url;
      alert('Skupna slika posodobljena');
    });
    $('notifTest').addEventListener('click', ()=> alert('MVP obvestilo: FCM integracija pride kasneje.'));
    $('logout').addEventListener('click', ()=> signOut(auth));

    // ====== Navigation shortcuts ======
    // srƒçek v seznamu pogovorov: toggle v Firestore (≈æe), klik partner srƒçek: odpri partner klepet (zgoraj)
  </script>
</body>
</html>