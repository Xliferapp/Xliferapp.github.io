<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Xlifer ‚Äì Domov PRO</title>
  <meta name="description" content="Xlifer Pro: aplikacija za pare in prijatelje, zgodbe, objave, klepeti z deljenjem, aplikacije, profil, klici prek WebRTC." />
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{
      --bg:#0b0f14; --surface:#0f172a; --card:#111827e6;
      --text:#f3f4f6; --muted:#9ca3af;
      --brand:#60a5fa; --brand2:#34d399;
      --danger:#ef4444; --ok:#22c55e; --warn:#f59e0b;
      --ring:0 0 0 3px rgba(96,165,250,.35);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
      background:var(--bg);color:var(--text);overflow-x:hidden;
      -webkit-tap-highlight-color:transparent}
    header{position:sticky;top:0;background:#0b0f1499;
      backdrop-filter:blur(10px);z-index:10;padding:12px 20px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid #1f2937}
    .logo{display:flex;gap:.6rem;align-items:center;font-weight:800}
    .logo-mark{width:28px;height:28px;border-radius:8px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 6px 18px rgba(52,211,153,.35)}
    main{padding:16px; padding-bottom:92px; animation:fade .3s ease}
    @keyframes fade{from{opacity:.0;transform:translateY(6px)}
      to{opacity:1;transform:translateY(0)}}

    /* Stories & Feed */
    .stories{display:flex;gap:12px;overflow-x:auto;padding:10px 0}
    .story{flex:0 0 80px;height:120px;border-radius:14px;
      background:var(--card);border:1px solid #1f2937;
      display:flex;align-items:center;justify-content:center;
      font-weight:700;cursor:pointer;transition:.25s transform}
    .story:hover{transform:scale(1.05)}
    .story img{width:100%;height:100%;object-fit:cover;border-radius:14px}
    .feed{display:grid;gap:16px;margin-top:16px}
    .post{background:var(--card);border:1px solid #1f2937;border-radius:16px;
      overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .post .head{display:flex;gap:10px;align-items:center;padding:10px}
    .avatar{width:36px;height:36px;border-radius:999px;overflow:hidden;
      border:1px solid #1f2937;flex-shrink:0}
    .post img{width:100%;height:auto;display:block}
    .post .meta{color:#cbd5e1;font-size:.85rem}
    .post .actions{display:flex;gap:10px;padding:10px}
    .btn{appearance:none;border:0;border-radius:12px;padding:.5rem .8rem;
      font-weight:600;cursor:pointer;background:#1f2937;color:#e5e7eb;
      transition:.2s}
    .btn:hover{opacity:.9}
    .btn.primary{background:linear-gradient(180deg,var(--brand),#2563eb);color:#fff}

    /* Friends */
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
    .threads{display:grid;gap:10px}
    .thread{display:flex;align-items:center;gap:10px;padding:10px;
      background:#0f172a;border:1px solid #1f2937;border-radius:14px;transition:.2s}
    .thread:hover{background:#1e293b}
    .thread .meta{flex:1}
    .heart{width:28px;height:28px;border-radius:999px;display:grid;
      place-items:center;cursor:pointer;border:1px solid #1f2937;transition:.2s}
    .heart.active{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff}

    /* Create */
    .composer{background:var(--card);border:1px solid #1f2937;
      border-radius:16px;padding:12px;display:grid;gap:10px}
    .toggle{display:inline-flex;background:#0b1320;border:1px solid #1f2937;
      border-radius:999px;overflow:hidden}
    .toggle button{border:0;padding:.5rem .9rem;background:transparent;
      color:#cbd5e1;cursor:pointer}
    .toggle button.active{background:linear-gradient(180deg,var(--brand),#2563eb);color:#fff}
    .canvas{height:280px;background:#0f172a;border:1px dashed #334155;
      border-radius:14px;display:grid;place-items:center;position:relative;overflow:hidden}
    .canvas img{max-width:100%;max-height:100%}
    .floating-text{position:absolute;top:40%;left:40%;
      padding:.2rem .4rem;background:#0006;border-radius:8px;cursor:move}

    /* Apps */
    .tabs{display:flex;gap:8px;overflow-x:auto;padding:6px}
    .tabs button{border:0;background:#1f2937;color:#e5e7eb;padding:.5rem .8rem;
      border-radius:10px;cursor:pointer;white-space:nowrap}
    .tabs button.active{background:linear-gradient(180deg,var(--brand),#2563eb)}
    .panel{background:var(--card);border:1px solid #1f2937;
      border-radius:16px;padding:12px}

    /* Profile */
    .profile{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:740px){.row{grid-template-columns:1fr}}
    .kebab{position:relative}
    .menu{position:absolute;right:0;top:110%;background:#0f172a;
      border:1px solid #1f2937;border-radius:12px;padding:8px;
      display:none;z-index:20}
    .menu.active{display:block}

    /* Chat */
    .modal{position:fixed;inset:0;background:#0009;display:none;
      align-items:center;justify-content:center;z-index:60}
    .modal.active{display:flex}
    .chat{width:min(920px,92vw);height:min(85vh,720px);
      background:#0f172a;border:1px solid #1f2937;border-radius:16px;
      display:grid;grid-template-rows:auto 1fr auto}
    .chat header{display:flex;align-items:center;justify-content:space-between;
      padding:10px;border-bottom:1px solid #1f2937}
    .msgs{overflow-y:auto;padding:10px;display:grid;gap:8px}
    .msg{max-width:70%;padding:.6rem .8rem;border-radius:14px;background:#111827}
    .msg.me{margin-left:auto;background:linear-gradient(180deg,#1f3b7a,#1e40af)}
    .chat footer{display:flex;gap:8px;padding:10px;border-top:1px solid #1f2937}

    /* Dock */
    .dock{position:fixed;bottom:12px;left:0;right:0;display:flex;
      justify-content:center;z-index:50}
    .dock-inner{display:flex;gap:10px;background:#0b1320;
      backdrop-filter:blur(10px);border:1px solid #1f2937;border-radius:20px;padding:8px}
    .dock button{appearance:none;border:0;background:transparent;color:#cbd5e1;
      padding:.5rem .8rem;border-radius:12px;display:flex;gap:6px;align-items:center;
      cursor:pointer;font-size:14px}
    .dock button.active{background:linear-gradient(135deg,var(--brand),var(--brand2));color:white}

    .toast{position:fixed;left:12px;bottom:84px;background:#0b1320cc;
      border:1px solid #1f2937;color:#fff;padding:10px 12px;border-radius:12px;
      max-width:70vw;z-index:200;display:none}
    .toast.show{display:block}
  </style>
</head>
<body>
  <header>
    <div class="logo"><div class="logo-mark"></div><span>Xlifer</span></div>
    <div id="topTitle">Domov</div>
  </header>

  <!-- HOME -->
  <main id="view-home">
    <div class="stories" id="stories"><div class="story">+</div></div>
    <div class="feed" id="feed"></div>
  </main>
    <!-- FRIENDS -->
  <main id="view-friends" style="display:none">
    <div class="toolbar">
      <div class="grow"><input id="friendSearch" type="search" placeholder="I≈°ƒçi‚Ä¶ (ime, @username)"></div>
      <button id="fltName" class="btn">A-≈Ω</button>
      <button id="fltTime" class="btn">ƒåas</button>
      <button id="fltFreq" class="btn">Pogostost</button>
      <button id="btnNewChat" class="btn primary">+ Nova grupa/pogovor</button>
      <button id="btnPartnerChat" class="btn" title="Zasebni klepet s partnerjem">‚ù§ Partner</button>
      <button id="btnAddFriend" class="btn">+ Dodaj prijatelja</button>
    </div>
    <div class="threads" id="threads"></div>
  </main>

  <!-- CREATE -->
  <main id="view-create" style="display:none">
    <div class="composer">
      <div class="toggle">
        <button id="modePost" class="active" type="button">Objava</button>
        <button id="modeStory" type="button">Zgodba</button>
      </div>
      <div class="row">
        <input id="imageFile" type="file" accept="image/*"/>
        <label class="btn"><input id="asCouple" type="checkbox" style="accent-color:#2563eb"> Objavi kot par</label>
      </div>
      <div class="row">
        <select id="filterSelect">
          <option value="none">Brez filtra</option>
          <option value="grayscale(1)">ƒårno-belo</option>
          <option value="contrast(1.3) saturate(1.2)">Kontrast + barve</option>
          <option value="sepia(.5) saturate(1.3)">Retro</option>
          <option value="blur(1px) brightness(1.1)">Soft</option>
        </select>
        <input id="caption" type="text" placeholder="Opis (za objavo)‚Ä¶"/>
      </div>
      <div class="canvas" id="canvas">
        <img id="canvasImg" alt="predogled"/>
        <div id="floatingText" class="floating-text" contenteditable="true" hidden>Premakni me ‚úçÔ∏è</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="publishBtn" class="btn primary">Objavi</button>
        <button id="clearBtn" class="btn">Poƒçisti</button>
      </div>
    </div>
  </main>

  <!-- APPS -->
  <main id="view-apps" style="display:none">
    <div class="tabs">
      <button class="active" data-tab="todo">To-Do</button>
      <button data-tab="notes">Bele≈æke</button>
      <button data-tab="calendar">Koledar</button>
      <button data-tab="album">Album</button>
    </div>
    <div id="tab-todo" class="panel"></div>
    <div id="tab-notes" class="panel" style="display:none"></div>
    <div id="tab-calendar" class="panel" style="display:none"></div>
    <div id="tab-album" class="panel" style="display:none"></div>
  </main>

  <!-- PROFILE -->
  <main id="view-profile" style="display:none">
    <div class="profile">
      <div class="row">
        <div style="display:flex;gap:10px;align-items:center" class="panel">
          <div class="avatar" style="width:72px;height:72px"><img id="meAvatar" alt="jaz"/></div>
          <div>
            <div style="font-weight:800" id="meName">‚Äî</div>
            <div class="meta" id="meEmail">‚Äî</div>
          </div>
        </div>
        <div class="panel kebab" style="text-align:right">
          <button id="kebabBtn" class="btn">‚ãØ</button>
          <div id="kebabMenu" class="menu">
            <div class="muted" style="margin-bottom:6px">Koda za linkanje:</div>
            <code id="partnerCode">‚Äî</code>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>Uredi profil</h3>
        <div class="row">
          <input id="pName" type="text" placeholder="Ime"/>
          <input id="pWeb" type="url" placeholder="Spletna stran"/>
        </div>
        <div class="row">
          <input id="pIG" type="text" placeholder="Instagram"/>
          <input id="pFB" type="text" placeholder="Facebook"/>
        </div>
        <div class="row">
          <input id="pSC" type="text" placeholder="Snapchat"/>
          <input id="pDOB" type="date" placeholder="Rojstni datum"/>
        </div>
        <textarea id="pBio" placeholder="O meni" style="min-height:110px;margin-top:8px"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="saveProfile" class="btn primary">üíæ Shrani</button>
          <button id="logout" class="btn">Odjava</button>
        </div>
      </div>

      <div class="panel">
        <h3>Par ‚Äì skupna slika</h3>
        <input id="coupleAvatarFile" type="file" accept="image/*"/>
        <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
          <div class="avatar" style="width:96px;height:96px"><img id="coupleAvatar" alt="par"/></div>
          <button id="uploadCoupleAvatar" class="btn">üì∑ Nalo≈æi skupno</button>
          <button id="refreshCode" class="btn">üîÑ Koda</button>
          <button id="copyCode" class="btn">üìã Kopiraj</button>
        </div>
        <div class="muted" style="margin-top:6px">
          V seznamih prijateljev se vidi tvoja + skupna slika (ne partnerjeva osebna).
        </div>
      </div>
    </div>
  </main>

  <!-- CHAT -->
  <div id="chatModal" class="modal">
    <div class="chat">
      <header>
        <div id="chatTitle">Klepet</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="chatShareToggle" class="heart" title="Deli ta klepet s partnerjem">‚ù§</div>
          <button id="callBtn" class="btn">üìû</button>
          <button id="videoBtn" class="btn">üé•</button>
          <button id="chatClose" class="btn">Zapri</button>
        </div>
      </header>
      <div id="chatMsgs" class="msgs"></div>
      <footer>
        <input id="chatInput" type="text" placeholder="Napi≈°i sporoƒçilo‚Ä¶"/>
        <button id="chatSend" class="btn primary">Po≈°lji</button>
      </footer>
    </div>
  </div>

  <!-- Dock -->
  <nav class="dock">
    <div class="dock-inner">
      <button data-view="home" class="active">üè† Domov</button>
      <button data-view="friends">üë• Friends</button>
      <button data-view="create">‚ûï Ustvari</button>
      <button data-view="apps">üóÇÔ∏è Aplikacije</button>
      <button data-view="profile">üë§ Profil</button>
    </div>
  </nav>

  <div id="toast" class="toast"></div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { 
    getFirestore, doc, setDoc, getDoc, addDoc, updateDoc, 
    collection, query, orderBy, onSnapshot, serverTimestamp, arrayUnion 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCaKT0CCg1xNJanG4-6Pox2UaH_1rSL3M0",
    authDomain: "chater2-fc480.firebaseapp.com",
    projectId: "chater2-fc480",
    storageBucket: "chater2-fc480.appspot.com",
    messagingSenderId: "623092508370",
    appId: "1:623092508370:web:08cf5d58c6edcfac096f0b"
  };

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const toast = document.getElementById("toast");
  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
  }

  // ==================== AUTH ====================
  onAuthStateChanged(auth, user => {
    if (!user) return location.href = "/index.html";
    loadFeed();
    loadThreads(user.uid);
  });
  document.getElementById("logout").addEventListener("click", () => signOut(auth));

  // ==================== FEED ====================
  async function loadFeed() {
    const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
    onSnapshot(q, snap => {
      const feed = document.getElementById("feed");
      feed.innerHTML = "";
      snap.forEach(docSnap => {
        const post = docSnap.data();
        const postId = docSnap.id;
        const el = document.createElement("div");
        el.className = "post";
        el.innerHTML = `
          <div class="head">
            <div class="avatar"><img src="${post.authorAvatar || ''}" alt=""/></div>
            <div><strong>${post.authorName}</strong>
              <div class="meta">${post.createdAt?.seconds ? new Date(post.createdAt.seconds*1000).toLocaleString() : ""}</div>
            </div>
          </div>
          ${post.image ? `<img src="${post.image}" alt="slika"/>` : ""}
          <div style="padding:10px">${post.caption || ""}</div>
          <div class="actions">
            <button class="btn likeBtn">‚ù§Ô∏è ${post.likes?.length || 0}</button>
            <button class="btn commentBtn">üí¨ ${post.comments?.length || 0}</button>
            <button class="btn shareBtn">‚ÜóÔ∏è</button>
          </div>
          <div class="comments"></div>
        `;

        // like
        el.querySelector(".likeBtn").addEventListener("click", async () => {
          const uid = auth.currentUser.uid;
          await updateDoc(doc(db, "posts", postId), { likes: arrayUnion(uid) });
        });

        // comment
        el.querySelector(".commentBtn").addEventListener("click", () => {
          const text = prompt("Napi≈°i komentar:");
          if (text) {
            updateDoc(doc(db, "posts", postId), {
              comments: arrayUnion({ uid: auth.currentUser.uid, text, at: Date.now() })
            });
          }
        });

        // share
        el.querySelector(".shareBtn").addEventListener("click", () => {
          navigator.clipboard.writeText(location.origin + "/post/" + postId);
          showToast("üîó Link do objave kopiran");
        });

        // prikaz komentarjev
        if (post.comments) {
          const cWrap = el.querySelector(".comments");
          post.comments.forEach(c => {
            const ce = document.createElement("div");
            ce.className = "meta";
            ce.textContent = c.text;
            cWrap.appendChild(ce);
          });
        }

        feed.appendChild(el);
      });
    });
  }

  // ==================== THREADS ====================
  async function loadThreads(uid) {
    const q = query(collection(db, "users", uid, "threads"), orderBy("lastAt", "desc"));
    onSnapshot(q, snap => {
      const threads = document.getElementById("threads");
      threads.innerHTML = "";
      snap.forEach(docSnap => {
        const t = docSnap.data();
        const el = document.createElement("div");
        el.className = "thread";
        el.innerHTML = `
          <div class="avatar"><img src="${t.avatar || ''}" alt=""/></div>
          <div class="meta"><strong>${t.name}</strong><div class="meta">${t.lastMsg || ""}</div></div>
          <div class="heart ${t.shared ? 'active' : ''}" data-id="${docSnap.id}">‚ù§</div>
        `;
        // srƒçek toggle
        el.querySelector(".heart").addEventListener("click", async (e) => {
          const newShared = !t.shared;
          await updateDoc(doc(db, "users", uid, "threads", docSnap.id), { shared: newShared });
          showToast(newShared ? "Pogovor deljen s partnerjem ‚ù§Ô∏è" : "Pogovor skrit od partnerja üíî");
        });
        threads.appendChild(el);
      });
    });
  }

  

  // ==================== TODO ====================
  const todoPanel = document.getElementById("tab-todo");
  todoPanel.innerHTML = `
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="todoInput" placeholder="Dodaj nalogo‚Ä¶" style="flex:1"/>
      <button id="todoAdd" class="btn primary">+</button>
    </div>
    <div id="todoList"></div>
  `;
  document.getElementById("todoAdd").addEventListener("click", async () => {
    const val = document.getElementById("todoInput").value.trim();
    if (!val) return;
    await addDoc(collection(db, "apps", auth.currentUser.uid, "todo"), { text: val, done: false, at: serverTimestamp() });
    document.getElementById("todoInput").value = "";
  });
  onSnapshot(collection(db, "apps", auth.currentUser.uid, "todo"), snap => {
    const list = document.getElementById("todoList");
    list.innerHTML = "";
    snap.forEach(d => {
      const t = d.data();
      const el = document.createElement("div");
      el.innerHTML = `<label><input type="checkbox" ${t.done ? "checked":""}/> ${t.text}</label>`;
      el.querySelector("input").addEventListener("change", () => updateDoc(doc(db,"apps",auth.currentUser.uid,"todo",d.id),{done:!t.done}));
      list.appendChild(el);
    });
  });

  // ==================== NOTES ====================
  const notesPanel = document.getElementById("tab-notes");
  notesPanel.innerHTML = `<textarea id="notesArea" style="width:100%;min-height:200px"></textarea><br><button id="saveNotes" class="btn primary">üíæ Shrani</button>`;
  const notesDoc = doc(db,"apps",auth.currentUser.uid,"notes","main");
  document.getElementById("saveNotes").addEventListener("click", async () => {
    await updateDoc(notesDoc,{text:document.getElementById("notesArea").value});
  });
  onSnapshot(notesDoc,snap=>{ if(snap.exists()) document.getElementById("notesArea").value = snap.data().text });

  // ==================== CALENDAR ====================
  const calPanel = document.getElementById("tab-calendar");
  calPanel.innerHTML = `
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="calDate" type="date"/>
      <input id="calTitle" placeholder="Dogodek"/>
      <button id="calAdd" class="btn primary">Dodaj</button>
    </div>
    <div id="calList"></div>
  `;
  document.getElementById("calAdd").addEventListener("click",async()=>{
    const d=document.getElementById("calDate").value;
    const t=document.getElementById("calTitle").value;
    if(!d||!t)return;
    await addDoc(collection(db,"apps",auth.currentUser.uid,"calendar"),{date:d,title:t,at:serverTimestamp()});
    document.getElementById("calTitle").value="";
  });
  onSnapshot(collection(db,"apps",auth.currentUser.uid,"calendar"),snap=>{
    const list=document.getElementById("calList");
    list.innerHTML="";
    snap.forEach(d=>{
      const ev=d.data();
      const el=document.createElement("div");
      el.textContent=`${ev.date}: ${ev.title}`;
      list.appendChild(el);
    });
  });

  // ==================== ALBUM ====================
  const albPanel = document.getElementById("tab-album");
  albPanel.innerHTML = `
    <input id="albFile" type="file" accept="image/*"/>
    <button id="albUpload" class="btn primary">Nalo≈æi</button>
    <div id="albGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:6px;margin-top:8px"></div>
  `;
  document.getElementById("albUpload").addEventListener("click",async()=>{
    const f=document.getElementById("albFile").files[0];
    if(!f)return;
    const r=ref(storage,"album/"+auth.currentUser.uid+"/"+Date.now()+"_"+f.name);
    await uploadBytes(r,f);
    const url=await getDownloadURL(r);
    await addDoc(collection(db,"apps",auth.currentUser.uid,"album"),{url,at:serverTimestamp()});
  });
  onSnapshot(collection(db,"apps",auth.currentUser.uid,"album"),snap=>{
    const g=document.getElementById("albGrid");
    g.innerHTML="";
    snap.forEach(d=>{
      const a=d.data();
      const el=document.createElement("img");
      el.src=a.url;
      el.style.width="100%";el.style.borderRadius="8px";
      g.appendChild(el);
    });
  });

  
  // Uporabi ≈æe inicializirane instance, ƒçe jih ima≈° v drugem bloku
  

  // UI elementi
  const callBtn   = document.getElementById('callBtn');
  const videoBtn  = document.getElementById('videoBtn');
  const chatTitle = document.getElementById('chatTitle');

  // Globalno: nastavi v openChat(threadId, name)
  // window.currentThreadId = "...";
  // window.currentThreadSnap = {...} // opcijsko, ƒçe ga ≈æe bere≈°

  // WebRTC state
  let pc = null;
  let localStream = null;
  let remoteStream = null;
  let activeCallRef = null;           // doc ref: threads/{threadId}/calls/{callId}
  let unsubCall = null;               // onSnapshot za call doc
  let unsubIncoming = null;           // onSnapshot poslu≈°anje dohodnih klicev
  let role = null;                    // 'caller' | 'callee'

  const rtcConfig = {
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" },
      { urls: "stun:stun1.l.google.com:19302" },
      { urls: "stun:stun2.l.google.com:19302" }
      // Za produkcijo dodaj TURN (npr. Twilio / owncoturn) za NAT traversal:
      // { urls: "turn:your.turn.server:3478", username: "user", credential: "pass" }
    ]
  };

  function ensureHttps() {
    const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    if (!isLocal && location.protocol !== 'https:') {
      console.warn('Za dostop do kamere/mikrofona je priporoƒçljiv HTTPS ali localhost.');
    }
  }

  // ======= UI handli =======
  callBtn?.addEventListener('click', () => startCall('audio'));
  videoBtn?.addEventListener('click', () => startCall('video'));

  // ======= Klicanje =======
  async function startCall(mode = 'audio') {
    ensureHttps();
    const threadId = window.currentThreadId;
    if (!threadId) { alert("Najprej odpri klepet."); return; }
    const user = auth.currentUser;
    if (!user) return;

    await cleanupCall(); // poƒçisti morebitno prej≈°njo sejo

    role = 'caller';
    pc = new RTCPeerConnection(rtcConfig);
    bindPeerEvents();

    // Media
    const constraints = { audio: true, video: mode === 'video' };
    localStream = await navigator.mediaDevices.getUserMedia(constraints);
    localStream.getTracks().forEach(tr => pc.addTrack(tr, localStream));
    // Pripravi remote stream (ƒçe rabi≈° prikaz, lahko doda≈° <video id="remoteVideo"> v modal)
    remoteStream = new MediaStream();

    // Ustvari call doc
    const callsCol = collection(db, 'threads', threadId, 'calls');
    const callDoc = await addDoc(callsCol, {
      initiatedBy: user.uid,
      mode,
      createdAt: serverTimestamp(),
      status: 'ringing'
    });
    activeCallRef = callDoc;

    // ICE kandidati (caller)
    const callerCandidates = collection(activeCallRef, 'callerCandidates');
    pc.addEventListener('icecandidate', async event => {
      if (event.candidate) {
        await addDoc(callerCandidates, event.candidate.toJSON());
      }
    });

    // Offer
    const offerDesc = await pc.createOffer();
    await pc.setLocalDescription(offerDesc);
    await updateDoc(activeCallRef, { offer: { sdp: offerDesc.sdp, type: offerDesc.type } });

    // Poslu≈°aj answer + callee ICE
    const calleeCandidates = collection(activeCallRef, 'calleeCandidates');
    unsubCall = onSnapshot(activeCallRef, async snap => {
      const data = snap.data();
      if (!pc) return;
      if (data?.answer && !pc.currentRemoteDescription) {
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      }
      if (data?.status === 'ended') {
        await cleanupCall();
      }
    });
    onSnapshot(calleeCandidates, snap => {
      snap.docChanges().forEach(change => {
        if (change.type === 'added') {
          const candidate = new RTCIceCandidate(change.doc.data());
          pc.addIceCandidate(candidate).catch(console.error);
        }
      });
    });

    alert(`üìû ${mode === 'video' ? 'Video' : 'Audio'} klic se vzpostavlja‚Ä¶ Druga stran bo videla povabilo v tem klepetu.`);
  }

  // ======= Sprejem dohodnega klica v tem threadu =======
  // Pokliƒçi to funkcijo v openChat(threadId, name) po tem, ko nastavi≈° window.currentThreadId
  window.setupIncomingCallWatcher = function setupIncomingCallWatcher(threadId) {
    // poƒçisti prej≈°nje poslu≈°alce
    if (unsubIncoming) { unsubIncoming(); unsubIncoming = null; }
    const callsCol = collection(db, 'threads', threadId, 'calls');
    unsubIncoming = onSnapshot(callsCol, snap => {
      snap.docChanges().forEach(async ch => {
        if (ch.type !== 'added') return;
        const callRef = doc(db, 'threads', threadId, 'calls', ch.doc.id);
        const data = ch.doc.data();
        const me = auth.currentUser?.uid;
        if (!me) return;
        if (data.initiatedBy === me) return; // to je na≈° klic
        if (data.status && data.status !== 'ringing') return;
        // Povabilo:
        const accept = confirm(`üì≤ Dohodni ${data.mode === 'video' ? 'video' : 'audio'} klic v: ${chatTitle?.textContent || 'klepet'}. Sprejmem?`);
        if (accept) {
          await joinCall(callRef, data.mode);
        } else {
          await updateDoc(callRef, { status: 'declined' });
        }
      });
    });
  }

  async function joinCall(callRef, mode = 'audio') {
    ensureHttps();
    await cleanupCall();
    role = 'callee';

    pc = new RTCPeerConnection(rtcConfig);
    bindPeerEvents();

    const constraints = { audio: true, video: mode === 'video' };
    localStream = await navigator.mediaDevices.getUserMedia(constraints);
    localStream.getTracks().forEach(tr => pc.addTrack(tr, localStream));

    activeCallRef = callRef;

    // ICE kandidati (callee)
    const calleeCandidates = collection(activeCallRef, 'calleeCandidates');
    pc.addEventListener('icecandidate', async event => {
      if (event.candidate) {
        await addDoc(calleeCandidates, event.candidate.toJSON());
      }
    });

    // Preberi offer, nastavi remote, kreiraj answer
    const callSnap = await getDoc(activeCallRef);
    const callData = callSnap.data();
    if (!callData?.offer) { alert("Klic ni veljaven."); return; }

    await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));
    const answerDesc = await pc.createAnswer();
    await pc.setLocalDescription(answerDesc);
    await updateDoc(activeCallRef, { answer: { type: answerDesc.type, sdp: answerDesc.sdp }, status: 'in-progress' });

    // Caller ICE
    const callerCandidates = collection(activeCallRef, 'callerCandidates');
    onSnapshot(callerCandidates, snap => {
      snap.docChanges().forEach(change => {
        if (change.type === 'added') {
          const cand = new RTCIceCandidate(change.doc.data());
          pc.addIceCandidate(cand).catch(console.error);
        }
      });
    });

    // Poslu≈°aj morebitne spremembe statusev (npr. zakljuƒçek)
    unsubCall = onSnapshot(activeCallRef, snap => {
      const d = snap.data();
      if (d?.status === 'ended' || d?.status === 'declined') {
        cleanupCall();
      }
    });
  }

  // ======= Peer events =======
  function bindPeerEvents() {
    pc.addEventListener('connectionstatechange', () => {
      console.log('Peer connection state:', pc.connectionState);
      if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
        cleanupCall();
      }
    });
    pc.addEventListener('track', ev => {
      if (!remoteStream) remoteStream = new MediaStream();
      remoteStream.addTrack(ev.track);
      // üëâ ƒåe ≈æeli≈° prikaz: dodaj v modal <video id="remoteVideo" autoplay playsinline></video>
      const rv = document.getElementById('remoteVideo');
      if (rv) {
        rv.srcObject = remoteStream;
      }
    });
  }

  // ======= Zakljuƒçi klic / ƒçi≈°ƒçenje =======
  async function cleanupCall() {
    try {
      if (pc) {
        pc.getSenders().forEach(s => { try { s.track?.stop(); } catch{} });
        pc.close();
      }
      if (localStream) localStream.getTracks().forEach(t => t.stop());
    } catch (e) { console.warn(e); }

    pc = null;
    localStream = null;
    remoteStream = null;

    if (unsubCall) { unsubCall(); unsubCall = null; }

    // Oznaƒçi call kot 'ended'
    try {
      if (activeCallRef) {
        await updateDoc(activeCallRef, { status: 'ended', endedAt: serverTimestamp() });
      }
    } catch (e) { /* ignore */ }

    activeCallRef = null;
    role = null;
  }

  // Opcijsko: doda≈° gumb "Konƒçaj" v UI in ga ve≈æe≈° na cleanupCall()
  // <button id="hangupBtn" class="btn">Konƒçaj</button>
  // document.getElementById('hangupBtn')?.addEventListener('click', cleanupCall);

  // ======= Integracija v obstojeƒç openChat =======
  // KJER IMA≈† DEKLARIRANO openChat(threadId, name) DODAJ:
  //   window.currentThreadId = threadId;
  //   window.setupIncomingCallWatcher(threadId);
</script>
</body>
</html>


